trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self

  # Install Terraform manually
  - script: |
      sudo apt-get update
      sudo apt-get install -y wget unzip
      wget https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip
      unzip terraform_1.9.8_linux_amd64.zip
      sudo mv terraform /usr/local/bin/
      terraform -version
    displayName: "Install Terraform"

  # Run Terraform inside Azure CLI context
  - task: AzureCLI@2
    displayName: "Terraform init/plan/apply"
    inputs:
      azureSubscription: "smu-guide-azure-sp"   # your service connection name
      scriptType: bash
      scriptLocation: inlineScript
      workingDirectory: "$(System.DefaultWorkingDirectory)/infra"
      inlineScript: |
        terraform init -input=false
        terraform plan -input=false

        if [ "$(Build.SourceBranch)" = "refs/heads/main" ]; then
          terraform apply -auto-approve -input=false
        else
          echo "Not on main branch, skipping apply"
        fi
